<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>S5 Camera All-in-One</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#10131a;
      --line:#1e2633;
      --text:#e9eefc;
      --muted:#9aa6c0;
      --accent:#7aa7ff;
      --btn:#1a2333;
    }
    *{box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0; background:var(--bg); color:var(--text);}
    .top{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.06);}
    .title{font-weight:900; letter-spacing:.3px;}
    .pill{border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:999px; color:var(--muted); background:rgba(255,255,255,.03); font-weight:800;}
    .wrap{max-width:900px; margin:0 auto; padding:12px;}
    .stage{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)); border:1px solid rgba(255,255,255,.07); border-radius:18px; overflow:hidden; position:relative;}
    #preview{width:100%; aspect-ratio:4/3; background:#000; object-fit:cover; display:block;}
    #overlay{position:absolute; inset:0; pointer-events:none; display:flex; align-items:flex-start; justify-content:center; padding:14px;}
    .hint{max-width:92%; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.25; backdrop-filter: blur(6px); opacity:.95;}
    .centerGuide{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:16px; backdrop-filter: blur(6px); font-weight:900; display:none; gap:10px; align-items:center;}
    .centerGuide span{color:var(--accent);}
    .row{display:flex; gap:10px; flex-wrap:wrap; padding:12px 2px 2px; align-items:center; justify-content:space-between;}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{background:var(--btn); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:10px 12px; font-weight:900; cursor:pointer;}
    button:active{transform:scale(.99);}
    button.primary{border-color:rgba(122,167,255,.45); box-shadow:0 0 0 2px rgba(122,167,255,.12) inset;}
    button.danger{border-color:rgba(255,120,120,.35);}
    .modebar{display:flex; gap:10px; overflow:auto; padding:12px 2px 6px; -webkit-overflow-scrolling: touch;}
    .mode{flex:0 0 auto; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); color:var(--muted); font-weight:900; white-space:nowrap;}
    .mode.active{color:var(--text); border-color:rgba(122,167,255,.6); box-shadow:0 0 0 2px rgba(122,167,255,.12) inset;}
    .bottom{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 2px 18px;}
    .thumb{width:70px; height:70px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:#000; object-fit:cover;}
    .shutter{width:84px; height:84px; border-radius:999px; border:4px solid rgba(255,255,255,.18); background:rgba(255,255,255,.05); display:grid; place-items:center;}
    .shutter .inner{width:58px; height:58px; border-radius:999px; background:#fff;}
    .rightBtns{display:flex; gap:10px; align-items:center;}
    .small{font-size:12px; color:var(--muted); margin-top:4px}
    .panel{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px 12px; margin-top:10px;}
    .panel h3{margin:0 0 6px; font-size:14px}
    .kv{display:flex; gap:10px; flex-wrap:wrap; font-size:13px; color:var(--muted)}
    .kv b{color:var(--text)}
    input[type="range"]{width:220px;}
    canvas{display:none;}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">S5 카메라</div>
    <div class="pill" id="modePill">PHOTO</div>
  </div>

  <div class="wrap">
    <div class="stage">
      <video id="preview" autoplay muted playsinline></video>
      <div id="overlay"><div class="hint" id="hint">“카메라 시작”을 눌러 미리보기를 켜세요.</div></div>

      <div class="centerGuide" id="wideGuide">
        <span id="arrow">←</span>
        <div>옆으로 천천히 · <span id="wideCount">0</span>/<span id="wideMax">6</span></div>
        <span id="arrow2">→</span>
      </div>

      <div class="centerGuide" id="surGuide">
        <span>↻</span>
        <div>주변 돌며 · <span id="surCount">0</span>/<span id="surMax">24</span></div>
        <span>↻</span>
      </div>
    </div>

    <div class="row">
      <div class="controls">
        <button class="primary" id="btnStart">카메라 시작</button>
        <button id="btnFlip">전/후면</button>
        <button id="btnStop" class="danger">정지</button>
      </div>
      <div class="controls">
        <button id="btnSave">저장</button>
      </div>
    </div>

    <div class="small" id="status">상태: 대기중</div>
    <div class="modebar" id="modebar"></div>

    <div class="bottom">
      <img id="thumb" class="thumb" alt="thumbnail"/>
      <div class="shutter" id="btnShutter" title="셔터"><div class="inner"></div></div>
      <div class="rightBtns">
        <button id="btnRec" class="primary">REC</button>
        <button id="btnClear">리셋</button>
      </div>
    </div>

    <div class="panel">
      <h3>옵션</h3>
      <div class="kv" id="settingsKV"></div>
      <div class="kv" id="extraControls"></div>
    </div>
  </div>

  <canvas id="capCanvas"></canvas>
  <canvas id="workCanvas"></canvas>

<script>
(() => {
  const video = document.getElementById('preview');
  const hint = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const modePill = document.getElementById('modePill');
  const modebar = document.getElementById('modebar');
  const thumb = document.getElementById('thumb');

  const capCanvas = document.getElementById('capCanvas');
  const workCanvas = document.getElementById('workCanvas');
  const capCtx = capCanvas.getContext('2d', { willReadFrequently:true });
  const workCtx = workCanvas.getContext('2d', { willReadFrequently:true });

  const wideGuide = document.getElementById('wideGuide');
  const wideCountEl = document.getElementById('wideCount');
  const wideMaxEl = document.getElementById('wideMax');
  const surGuide = document.getElementById('surGuide');
  const surCountEl = document.getElementById('surCount');
  const surMaxEl = document.getElementById('surMax');

  let stream = null;
  let currentFacing = 'user';
  let currentMode = 'photo';
  let lastBlobUrl = null;

  // shared frame buffer (for pano / motionpano / shotmore / wide)
  let frames = [];
  // wide selfie
  let wideMax = 6;
  let wideOverlap = 0.28;
  let wideDirection = 1;

  // surround
  let surroundFrames = [];
  let surroundMax = 24;

  // outfocus
  let outBlur = 10;

  // beauty
  let beauty = { smooth: 8, bright: 10 };

  // speed modes
  let playbackRate = 1.0;

  let mediaRecorder = null;
  let recordedChunks = [];

  const MODES = [
    { id:'photo', label:'사진', pill:'PHOTO' },
    { id:'video', label:'동영상', pill:'VIDEO' },
    { id:'panorama', label:'파노라마', pill:'PANO' },
    { id:'motionpano', label:'모션파노라마', pill:'M-PANO' },
    { id:'pro', label:'프로', pill:'PRO' },

    { id:'shotmore', label:'샷&모어', pill:'SHOT' },
    { id:'aqua', label:'아쿠아', pill:'AQUA' },
    { id:'outfocus', label:'아웃포커스', pill:'BOKEH' },
    { id:'wideselfie', label:'와이드셀프샷', pill:'WIDE' },
    { id:'rearcamsel', label:'리어캠 셀피', pill:'REAR' },

    { id:'slow', label:'슬로우(0.5x)', pill:'SLOW' },
    { id:'fast', label:'패스트(4x)', pill:'FAST' },

    { id:'beauty', label:'뷰티페이스', pill:'BEAUTY' },
    { id:'multiview', label:'멀티뷰샷', pill:'MULTI' },
    { id:'surround', label:'서라운드샷', pill:'360' },
  ];

  const clamp = (v)=>Math.max(0, Math.min(255, v|0));

  function status(t){ statusEl.textContent = '상태: ' + t; }

  function buildModebar(){
    modebar.innerHTML = '';
    MODES.forEach(m=>{
      const b = document.createElement('button');
      b.className = 'mode' + (m.id===currentMode ? ' active':'');
      b.textContent = m.label;
      b.onclick = ()=> setMode(m.id);
      modebar.appendChild(b);
    });
  }

  function setHintForMode(){
    const map = {
      photo:'셔터로 사진 촬영',
      video:'REC로 녹화 시작/정지',
      panorama:'셔터 여러 번 → 저장(이어붙이기)',
      motionpano:'셔터 여러 번 → 저장(움직임 느낌)',
      pro:'간단 수동 느낌(보정 없음)',
      shotmore:'셔터 여러 번 → 저장(평균 합성)',
      aqua:'물속 느낌 필터로 저장',
      outfocus:'중앙 선명 + 주변 블러',
      wideselfie:'좌우로 움직이며 여러 번 셔터 → 저장(이어붙이기)',
      rearcamsel:'후면 카메라로 셀피(거울 느낌)',
      slow:'동영상 저장 후 0.5x 재생(앱에서)',
      fast:'동영상 저장 후 4x 재생(앱에서)',
      beauty:'뷰티페이스(뽀샤시/밝기)',
      multiview:'2x2 멀티뷰 콜라주 저장',
      surround:'셔터 여러 번 → 저장(WebM 360 느낌)'
    };
    hint.textContent = map[currentMode] || '모드 선택';
  }

  function setMode(id){
    currentMode = id;
    buildModebar();
    const m = MODES.find(x=>x.id===id);
    modePill.textContent = m ? m.pill : 'MODE';
    setHintForMode();
    renderSettings();

    wideGuide.style.display = (id==='wideselfie') ? 'flex' : 'none';
    surGuide.style.display  = (id==='surround') ? 'flex' : 'none';

    if(id==='wideselfie'){
      wideCountEl.textContent = String(frames.length);
      wideMaxEl.textContent = String(wideMax);
      document.getElementById('arrow').textContent = wideDirection===1?'←':'→';
      document.getElementById('arrow2').textContent = wideDirection===1?'→':'←';
    }
    if(id==='surround'){
      surCountEl.textContent = String(surroundFrames.length);
      surMaxEl.textContent = String(surroundMax);
    }

    if(id==='rearcamsel'){
      currentFacing = 'environment';
      if(stream) startCamera();
    }

    if(id==='slow') playbackRate = 0.5;
    else if(id==='fast') playbackRate = 4.0;
    else playbackRate = 1.0;
  }

  function renderSettings(){
    const kv = document.getElementById('settingsKV');
    const extra = document.getElementById('extraControls');
    kv.innerHTML=''; extra.innerHTML='';

    const addKV=(k,v)=>{
      const s=document.createElement('span');
      s.innerHTML = `<b>${k}</b>: ${v}`;
      kv.appendChild(s);
    };
    addKV('카메라', currentFacing==='user'?'전면':'후면');
    addKV('미리보기', stream?'ON':'OFF');
    addKV('모드', MODES.find(m=>m.id===currentMode)?.label || currentMode);

    // wide options
    if(currentMode==='wideselfie'){
      const w1=document.createElement('span');
      w1.innerHTML = `겹침 <input id="ov" type="range" min="0.15" max="0.45" step="0.01" value="${wideOverlap}"> <b id="ovv">${Math.round(wideOverlap*100)}%</b>`;
      extra.appendChild(w1);
      const w2=document.createElement('span');
      w2.innerHTML = `최대 <input id="wm" type="range" min="2" max="10" step="1" value="${wideMax}"> <b id="wmv">${wideMax}</b>`;
      extra.appendChild(w2);
      const w3=document.createElement('span');
      const btn=document.createElement('button');
      btn.textContent = wideDirection===1?'방향: 오른쪽→':'방향: ←왼쪽';
      btn.onclick=()=>{
        wideDirection*=-1;
        btn.textContent = wideDirection===1?'방향: 오른쪽→':'방향: ←왼쪽';
        document.getElementById('arrow').textContent = wideDirection===1?'←':'→';
        document.getElementById('arrow2').textContent = wideDirection===1?'→':'←';
      };
      w3.appendChild(btn); extra.appendChild(w3);

      setTimeout(()=>{
        const ov=document.getElementById('ov'), ovv=document.getElementById('ovv');
        const wm=document.getElementById('wm'), wmv=document.getElementById('wmv');
        ov.oninput=()=>{ wideOverlap=parseFloat(ov.value); ovv.textContent=`${Math.round(wideOverlap*100)}%`; };
        wm.oninput=()=>{ wideMax=parseInt(wm.value,10); wmv.textContent=wm.value; wideMaxEl.textContent=wm.value; };
      },0);
    }

    // outfocus
    if(currentMode==='outfocus'){
      const b=document.createElement('span');
      b.innerHTML = `블러 <input id="ob" type="range" min="4" max="20" step="1" value="${outBlur}"> <b id="obv">${outBlur}</b>`;
      extra.appendChild(b);
      setTimeout(()=>{
        const ob=document.getElementById('ob'), obv=document.getElementById('obv');
        ob.oninput=()=>{ outBlur=parseInt(ob.value,10); obv.textContent=ob.value; };
      },0);
    }

    // beauty
    if(currentMode==='beauty'){
      const w1=document.createElement('span');
      w1.innerHTML = `부드러움 <input id="bs" type="range" min="0" max="20" step="1" value="${beauty.smooth}"> <b id="bsv">${beauty.smooth}</b>`;
      extra.appendChild(w1);
      const w2=document.createElement('span');
      w2.innerHTML = `밝기 <input id="bb" type="range" min="-10" max="25" step="1" value="${beauty.bright}"> <b id="bbv">${beauty.bright}</b>`;
      extra.appendChild(w2);
      setTimeout(()=>{
        const bs=document.getElementById('bs'), bsv=document.getElementById('bsv');
        const bb=document.getElementById('bb'), bbv=document.getElementById('bbv');
        bs.oninput=()=>{ beauty.smooth=+bs.value; bsv.textContent=bs.value; };
        bb.oninput=()=>{ beauty.bright=+bb.value; bbv.textContent=bb.value; };
      },0);
    }

    // surround max
    if(currentMode==='surround'){
      const w=document.createElement('span');
      w.innerHTML = `프레임 <input id="sm" type="range" min="8" max="40" step="1" value="${surroundMax}"> <b id="smv">${surroundMax}</b>`;
      extra.appendChild(w);
      setTimeout(()=>{
        const sm=document.getElementById('sm'), smv=document.getElementById('smv');
        sm.oninput=()=>{ surroundMax=+sm.value; smv.textContent=sm.value; surMaxEl.textContent=sm.value; };
      },0);
    }
  }

  async function startCamera(){
    try{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      status('카메라 요청중…');
      stream = await navigator.mediaDevices.getUserMedia({
        audio:false,
        video:{
          facingMode:{ ideal: currentFacing },
          width:{ ideal:1280 },
          height:{ ideal:960 }
        }
      });
      video.srcObject = stream;

      await new Promise(res=>{
        if(video.readyState>=1) return res();
        video.onloadedmetadata=()=>res();
      });

      await video.play();
      status('미리보기 ON ✅');
      renderSettings();
    }catch(e){
      console.error(e);
      status('카메라 실패 ❌');
      hint.textContent='HTTPS + 카메라 권한 허용 확인!';
    }
  }

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null;
    status('미리보기 OFF');
    renderSettings();
  }

  function canvasToBlob(c, type='image/jpeg', q=0.92){
    return new Promise(res=>c.toBlob(res,type,q));
  }
  function downloadBlob(blob, filename){
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
  }
  function setThumb(blob){
    if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl=URL.createObjectURL(blob);
    thumb.src=lastBlobUrl;
  }

  function grab(){
    const w=video.videoWidth||1280;
    const h=video.videoHeight||960;
    capCanvas.width=w; capCanvas.height=h;
    capCtx.drawImage(video,0,0,w,h);
    workCanvas.width=w; workCanvas.height=h;
    workCtx.clearRect(0,0,w,h);
    workCtx.drawImage(capCanvas,0,0,w,h);
    return {w,h};
  }

  function applyAqua(ctx,w,h){
    const img=ctx.getImageData(0,0,w,h);
    const d=img.data;
    for(let i=0;i<d.length;i+=4){
      let r=d[i], g=d[i+1], b=d[i+2];
      b=Math.min(255, b*1.20+18);
      g=Math.min(255, g*1.08+6);
      r=Math.max(0, r*0.92-4);
      d[i]=clamp((r-128)*1.05+128);
      d[i+1]=clamp((g-128)*1.05+128);
      d[i+2]=clamp((b-128)*1.05+128);
    }
    ctx.putImageData(img,0,0);
  }

  function applyBeauty(ctx,w,h){
    const tmp=document.createElement('canvas');
    tmp.width=w; tmp.height=h;
    const t=tmp.getContext('2d');
    t.drawImage(ctx.canvas,0,0);

    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.filter=`brightness(${100+beauty.bright}%) saturate(108%)`;
    ctx.drawImage(tmp,0,0);
    ctx.filter='none';
    ctx.restore();

    if(beauty.smooth>0){
      const blurC=document.createElement('canvas');
      blurC.width=w; blurC.height=h;
      const b=blurC.getContext('2d');
      b.filter=`blur(${Math.max(1,beauty.smooth/2)}px)`;
      b.drawImage(ctx.canvas,0,0);
      b.filter='none';

      ctx.save();
      ctx.globalAlpha=Math.min(0.55,Math.max(0.08,beauty.smooth/18));
      ctx.drawImage(blurC,0,0);
      ctx.restore();
    }
  }

  function applyOutfocus(w,h){
    const original=workCtx.getImageData(0,0,w,h);

    workCtx.clearRect(0,0,w,h);
    workCtx.filter=`blur(${outBlur}px)`;
    workCtx.drawImage(capCanvas,0,0,w,h);
    workCtx.filter='none';

    const cx=w/2, cy=h/2;
    const radius=Math.min(w,h)*0.28;
    const feather=radius*0.55;

    const temp=document.createElement('canvas');
    temp.width=w; temp.height=h;
    temp.getContext('2d').putImageData(original,0,0);

    const mask=document.createElement('canvas');
    mask.width=w; mask.height=h;
    const mctx=mask.getContext('2d');
    const grad=mctx.createRadialGradient(cx,cy,radius,cx,cy,radius+feather);
    grad.addColorStop(0,'rgba(255,255,255,1)');
    grad.addColorStop(1,'rgba(255,255,255,0)');
    mctx.fillStyle=grad;
    mctx.fillRect(0,0,w,h);

    const masked=document.createElement('canvas');
    masked.width=w; masked.height=h;
    const mx=masked.getContext('2d');
    mx.drawImage(temp,0,0);
    mx.globalCompositeOperation='destination-in';
    mx.drawImage(mask,0,0);

    workCtx.drawImage(masked,0,0);
  }

  async function makeMultiviewBlob(w,h){
    const outW=1080, outH=1080;
    const c=document.createElement('canvas');
    c.width=outW; c.height=outH;
    const x=c.getContext('2d');
    const cell=outW/2;

    const src=document.createElement('canvas');
    src.width=w; src.height=h;
    src.getContext('2d').drawImage(capCanvas,0,0);

    const drawCrop=(srcCanvas,dx,dy,zoom)=>{
      const sw=srcCanvas.width, sh=srcCanvas.height;
      const z=1+zoom;
      const cw=sw/z, ch=sh/z;
      const sx=(sw-cw)/2, sy=(sh-ch)/2;
      x.drawImage(srcCanvas,sx,sy,cw,ch,dx,dy,cell,cell);
    };

    drawCrop(src,0,0,0);
    drawCrop(src,cell,0,-0.10);

    const bC=document.createElement('canvas');
    bC.width=w; bC.height=h;
    const bc=bC.getContext('2d',{willReadFrequently:true});
    bc.drawImage(src,0,0);
    applyBeauty(bc,w,h);
    drawCrop(bC,0,cell,0);

    const vivid=document.createElement('canvas');
    vivid.width=w; vivid.height=h;
    const vc=vivid.getContext('2d',{willReadFrequently:true});
    vc.drawImage(src,0,0);
    const img=vc.getImageData(0,0,w,h);
    const d=img.data;
    for(let i=0;i<d.length;i+=4){
      d[i]=clamp((d[i]-128)*1.08+128);
      d[i+1]=clamp((d[i+1]-128)*1.08+128);
      d[i+2]=clamp((d[i+2]-128)*1.08+128);
    }
    vc.putImageData(img,0,0);
    drawCrop(vivid,cell,cell,0);

    x.save();
    x.fillStyle='rgba(255,255,255,.35)';
    x.fillRect(cell-1,0,2,outH);
    x.fillRect(0,cell-1,outW,2);
    x.restore();

    return await canvasToBlob(c,'image/jpeg',0.92);
  }

  function pickRecorderOptions(){
    const cands=[
      { mimeType:'video/webm;codecs=vp9' },
      { mimeType:'video/webm;codecs=vp8' },
      { mimeType:'video/webm' },
      {}
    ];
    for(const opt of cands){
      try{
        if(!opt.mimeType) return opt;
        if(MediaRecorder.isTypeSupported(opt.mimeType)) return opt;
      }catch(_){}
    }
    return {};
  }

  async function toggleRecord(){
    if(!stream){ status('카메라부터 시작!'); return; }
    if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); return; }

    recordedChunks=[];
    try{
      mediaRecorder=new MediaRecorder(stream, pickRecorderOptions());
    }catch(e){
      console.error(e);
      status('녹화 불가(브라우저 제한)');
      return;
    }

    mediaRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop=()=>{
      const blob=new Blob(recordedChunks,{type: recordedChunks[0]?.type || 'video/webm'});
      downloadBlob(blob, `s5_${currentMode}_video_${Date.now()}.webm`);
      status('동영상 저장 완료 ✅');
      if(currentMode==='slow' || currentMode==='fast'){
        hint.textContent=`저장된 영상은 기본속도예요. 재생앱에서 ${playbackRate}x로 재생!`;
      }
    };
    mediaRecorder.start();
    status('녹화중… ⏺️');
  }

  async function saveSurroundWebm(){
    if(surroundFrames.length<2){ status('서라운드샷 2장 이상 필요'); return; }
    const base=surroundFrames[0];
    const w=base.width, h=base.height;
    const c=document.createElement('canvas');
    c.width=w; c.height=h;
    const x=c.getContext('2d',{willReadFrequently:true});

    const s=c.captureStream(15);
    const rec=new MediaRecorder(s,{mimeType:'video/webm;codecs=vp8'});
    const chunks=[];
    rec.ondataavailable=(e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
    rec.onstop=()=>{
      const blob=new Blob(chunks,{type:'video/webm'});
      downloadBlob(blob, `s5_surround_${Date.now()}.webm`);
      status('서라운드샷 저장 완료 ✅');
    };
    rec.start();

    const seq=surroundFrames.concat(surroundFrames.slice(1,-1).reverse());
    let i=0;
    const timer=setInterval(()=>{
      x.putImageData(seq[i],0,0);
      x.save();
      x.fillStyle='rgba(0,0,0,.35)';
      x.fillRect(12,12,240,34);
      x.fillStyle='#fff';
      x.font='18px system-ui';
      x.fillText('SURROUND SHOT',22,36);
      x.restore();

      i++;
      if(i>=seq.length){ clearInterval(timer); rec.stop(); }
    },120);
  }

  async function saveStitched(){
    if(frames.length===0){ status('합칠 프레임 없음'); return; }

    // shotmore = average blend
    if(currentMode==='shotmore'){
      const img0=frames[0];
      const w=img0.width, h=img0.height;
      workCanvas.width=w; workCanvas.height=h;
      const out=workCtx.createImageData(w,h);
      const n=frames.length;
      for(let i=0;i<out.data.length;i+=4){
        let r=0,g=0,b=0,a=0;
        for(const fr of frames){
          r+=fr.data[i]; g+=fr.data[i+1]; b+=fr.data[i+2]; a+=fr.data[i+3];
        }
        out.data[i]=(r/n)|0; out.data[i+1]=(g/n)|0; out.data[i+2]=(b/n)|0; out.data[i+3]=(a/n)|0;
      }
      workCtx.putImageData(out,0,0);
      const blob=await canvasToBlob(workCanvas);
      setThumb(blob);
      downloadBlob(blob, `s5_shotmore_${Date.now()}.jpg`);
      status('샷&모어 저장 ✅');
      return;
    }

    // stitched (wide/pano/motionpano)
    const base=frames[0];
    const fw=base.width, fh=base.height;
    const overlapPx=Math.floor(fw*wideOverlap);
    const step=fw-overlapPx;
    const count=frames.length;
    const totalW=fw + step*(count-1);

    workCanvas.width=totalW;
    workCanvas.height=fh;
    workCtx.clearRect(0,0,totalW,fh);
    workCtx.fillStyle='#000';
    workCtx.fillRect(0,0,totalW,fh);

    for(let k=0;k<count;k++){
      const x = (wideDirection===1) ? (k*step) : ((count-1-k)*step);

      const tmp=document.createElement('canvas');
      tmp.width=fw; tmp.height=fh;
      tmp.getContext('2d').putImageData(frames[k],0,0);

      const mask=document.createElement('canvas');
      mask.width=fw; mask.height=fh;
      const m=mask.getContext('2d');
      const g=m.createLinearGradient(0,0,fw,0);
      if(k===0){
        g.addColorStop(0,'rgba(255,255,255,1)');
        g.addColorStop(1,'rgba(255,255,255,1)');
      }else{
        const p=overlapPx/fw;
        g.addColorStop(0,'rgba(255,255,255,0)');
        g.addColorStop(Math.max(0,p*0.85),'rgba(255,255,255,0)');
        g.addColorStop(Math.min(1,p),'rgba(255,255,255,1)');
        g.addColorStop(1,'rgba(255,255,255,1)');
      }
      m.fillStyle=g;
      m.fillRect(0,0,fw,fh);

      const masked=document.createElement('canvas');
      masked.width=fw; masked.height=fh;
      const mx=masked.getContext('2d');
      mx.drawImage(tmp,0,0);
      mx.globalCompositeOperation='destination-in';
      mx.drawImage(mask,0,0);

      workCtx.drawImage(masked,x,0);
    }

    const blob=await canvasToBlob(workCanvas,'image/jpeg',0.9);
    setThumb(blob);
    downloadBlob(blob, `s5_${currentMode}_${Date.now()}.jpg`);
    status('이어붙이기 저장 ✅');
  }

  async function onShutter(){
    if(!stream){ status('카메라부터 시작!'); return; }
    const {w,h}=grab();

    // special capture modes
    if(currentMode==='shotmore' || currentMode==='wideselfie' || currentMode==='panorama' || currentMode==='motionpano'){
      frames.push(workCtx.getImageData(0,0,w,h));
      if(currentMode==='wideselfie'){
        wideCountEl.textContent=String(frames.length);
        wideMaxEl.textContent=String(wideMax);
      }
      status(`프레임 ${frames.length}장 저장됨`);
      hint.textContent=`셔터 계속 / “저장” 눌러 합치기 (${frames.length}장)`;
      return;
    }

    if(currentMode==='surround'){
      surroundFrames.push(workCtx.getImageData(0,0,w,h));
      surCountEl.textContent=String(surroundFrames.length);
      surMaxEl.textContent=String(surroundMax);
      status(`서라운드샷 ${surroundFrames.length}/${surroundMax}`);
      hint.textContent=`주변을 돌며 셔터! (${surroundFrames.length}/${surroundMax})`;
      return;
    }

    // single-shot photo filters
    if(currentMode==='aqua') applyAqua(workCtx,w,h);
    if(currentMode==='outfocus') applyOutfocus(w,h);
    if(currentMode==='beauty') applyBeauty(workCtx,w,h);

    if(currentMode==='multiview'){
      const blob=await makeMultiviewBlob(w,h);
      setThumb(blob);
      downloadBlob(blob, `s5_multiview_${Date.now()}.jpg`);
      status('멀티뷰샷 저장 ✅');
      return;
    }

    const blob=await canvasToBlob(workCanvas);
    setThumb(blob);
    downloadBlob(blob, `s5_${currentMode}_${Date.now()}.jpg`);
    status('사진 저장 ✅');
  }

  document.getElementById('btnStart').onclick=async()=>{ await startCamera(); };
  document.getElementById('btnStop').onclick=()=>stopCamera();
  document.getElementById('btnFlip').onclick=async()=>{
    currentFacing = (currentFacing==='user')?'environment':'user';
    if(stream) await startCamera();
    renderSettings();
  };
  document.getElementById('btnShutter').onclick=()=>onShutter();
  document.getElementById('btnRec').onclick=()=>toggleRecord();

  document.getElementById('btnSave').onclick=async()=>{
    if(currentMode==='surround'){ await saveSurroundWebm(); return; }
    if(currentMode==='shotmore' || currentMode==='wideselfie' || currentMode==='panorama' || currentMode==='motionpano'){
      await saveStitched(); return;
    }
    status('이 모드는 자동 저장');
  };

  document.getElementById('btnClear').onclick=()=>{
    frames=[]; surroundFrames=[];
    wideCountEl.textContent='0';
    surCountEl.textContent='0';
    status('리셋 완료');
    setHintForMode();
  };

  buildModebar();
  setMode('photo');
  renderSettings();
  hint.textContent='미리보기는 “카메라 시작”을 눌러 켜요(폰 자동재생 차단).';
})();
</script>
</body>
</html>