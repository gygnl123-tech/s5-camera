<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>S5 Camera (Beauty / Surround / MultiView)</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#10131a;
      --line:#1e2633;
      --text:#e9eefc;
      --muted:#9aa6c0;
      --accent:#7aa7ff;
      --btn:#1a2333;
    }
    *{box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0; background:var(--bg); color:var(--text);}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .title{font-weight:800; letter-spacing:.3px;}
    .pill{
      border:1px solid rgba(255,255,255,.12);
      padding:8px 12px; border-radius:999px; color:var(--muted);
      background:rgba(255,255,255,.03);
      font-weight:700;
    }
    .wrap{max-width:900px; margin:0 auto; padding:12px;}
    .stage{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.07);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }
    #preview{
      width:100%;
      aspect-ratio:4/3;
      background:#000;
      object-fit:cover;
      display:block;
    }
    #overlay{
      position:absolute; inset:0;
      pointer-events:none;
      display:flex; align-items:flex-start; justify-content:center;
      padding:14px;
    }
    .hint{
      max-width:92%;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      line-height:1.25;
      backdrop-filter: blur(6px);
      opacity:.95;
    }
    .centerGuide{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:16px;
      backdrop-filter: blur(6px);
      font-weight:800;
      display:none;
      gap:10px; align-items:center;
    }
    .centerGuide span{color:var(--accent);}
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:12px 2px 2px;
      align-items:center; justify-content:space-between;
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    button{
      background:var(--btn);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
    }
    button:active{transform:scale(.99);}
    button.primary{border-color:rgba(122,167,255,.45); box-shadow:0 0 0 2px rgba(122,167,255,.12) inset;}
    button.danger{border-color:rgba(255,120,120,.35);}
    .modebar{
      display:flex; gap:10px;
      overflow:auto;
      padding:12px 2px 6px;
      -webkit-overflow-scrolling: touch;
    }
    .mode{
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    .mode.active{
      color:var(--text);
      border-color:rgba(122,167,255,.6);
      box-shadow:0 0 0 2px rgba(122,167,255,.12) inset;
    }
    .bottom{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 2px 18px;
    }
    .thumb{
      width:70px; height:70px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
      object-fit:cover;
    }
    .shutter{
      width:84px; height:84px; border-radius:999px;
      border:4px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.05);
      display:grid; place-items:center;
    }
    .shutter .inner{
      width:58px; height:58px; border-radius:999px;
      background:#fff;
    }
    .rightBtns{display:flex; gap:10px; align-items:center;}
    .small{font-size:12px; color:var(--muted); margin-top:4px}
    .panel{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
      margin-top:10px;
    }
    .panel h3{margin:0 0 6px; font-size:14px}
    .kv{display:flex; gap:10px; flex-wrap:wrap; font-size:13px; color:var(--muted)}
    .kv b{color:var(--text)}
    input[type="range"]{width:220px;}
    canvas{display:none;}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">S5 카메라</div>
    <div class="pill" id="modePill">PHOTO</div>
  </div>

  <div class="wrap">
    <div class="stage">
      <video id="preview" autoplay muted playsinline></video>
      <div id="overlay"><div class="hint" id="hint">아래 “카메라 시작”을 눌러 미리보기를 켜세요.</div></div>

      <div class="centerGuide" id="surroundGuide">
        <span>↻</span>
        <div>주변을 돌면서 촬영 · <span id="surCount">0</span>/<span id="surMax">24</span></div>
        <span>↻</span>
      </div>
    </div>

    <div class="row">
      <div class="controls">
        <button class="primary" id="btnStart">카메라 시작</button>
        <button id="btnFlip">전/후면</button>
        <button id="btnStop" class="danger">정지</button>
      </div>
      <div class="controls">
        <button id="btnSave">저장</button>
      </div>
    </div>
    <div class="small" id="status">상태: 대기중</div>

    <div class="modebar" id="modebar"></div>

    <div class="bottom">
      <img id="thumb" class="thumb" alt="thumbnail"/>
      <div class="shutter" id="btnShutter" title="셔터">
        <div class="inner"></div>
      </div>
      <div class="rightBtns">
        <button id="btnClear">리셋</button>
      </div>
    </div>

    <div class="panel">
      <h3>옵션</h3>
      <div class="kv" id="settingsKV"></div>
      <div class="kv" id="extraControls"></div>
    </div>
  </div>

  <canvas id="capCanvas"></canvas>
  <canvas id="workCanvas"></canvas>

<script>
(() => {
  const video = document.getElementById('preview');
  const hint = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const modePill = document.getElementById('modePill');
  const modebar = document.getElementById('modebar');
  const thumb = document.getElementById('thumb');

  const capCanvas = document.getElementById('capCanvas');
  const workCanvas = document.getElementById('workCanvas');
  const capCtx = capCanvas.getContext('2d', { willReadFrequently: true });
  const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

  const surroundGuide = document.getElementById('surroundGuide');
  const surCountEl = document.getElementById('surCount');
  const surMaxEl = document.getElementById('surMax');

  let stream = null;
  let currentFacing = 'user';
  let currentMode = 'photo';
  let lastBlobUrl = null;

  // Beauty options
  let beauty = { smooth: 8, bright: 10 };

  // Surround frames
  let surroundFrames = [];
  let surroundMax = 24;

  const MODES = [
    { id:'photo', label:'사진', pill:'PHOTO' },
    { id:'beauty', label:'뷰티페이스', pill:'BEAUTY' },
    { id:'multiview', label:'멀티뷰샷', pill:'MULTI' },
    { id:'surround', label:'서라운드샷', pill:'360' },
  ];

  function clamp255(v){ return Math.max(0, Math.min(255, v|0)); }

  function buildModebar(){
    modebar.innerHTML = '';
    MODES.forEach(m=>{
      const b = document.createElement('button');
      b.className = 'mode' + (m.id===currentMode ? ' active':'');
      b.textContent = m.label;
      b.onclick = ()=> setMode(m.id);
      modebar.appendChild(b);
    });
  }

  function setMode(id){
    currentMode = id;
    buildModebar();
    const m = MODES.find(x=>x.id===id);
    modePill.textContent = m ? m.pill : 'MODE';
    setHintForMode();
    renderSettings();

    if(id==='surround'){
      surroundGuide.style.display = 'flex';
      surCountEl.textContent = String(surroundFrames.length);
      surMaxEl.textContent = String(surroundMax);
    }else{
      surroundGuide.style.display = 'none';
    }
  }

  function setHintForMode(){
    const map = {
      photo:'셔터로 사진 촬영',
      beauty:'셔터로 캡처 → 뽀샤시/밝게 → 자동 저장',
      multiview:'셔터 1번 → 2x2 멀티뷰 콜라주 저장',
      surround:'셔터를 여러 번(주변을 돌며) → 저장하면 움직이는 360 느낌 WebM'
    };
    hint.textContent = map[currentMode] || '모드 선택';
  }

  function renderSettings(){
    const kv = document.getElementById('settingsKV');
    const extra = document.getElementById('extraControls');
    kv.innerHTML = '';
    extra.innerHTML = '';

    const addKV = (k,v)=> {
      const span = document.createElement('span');
      span.innerHTML = `<b>${k}</b>: ${v}`;
      kv.appendChild(span);
    };

    addKV('카메라', currentFacing==='user'?'전면':'후면');
    addKV('미리보기', stream?'ON':'OFF');
    addKV('모드', MODES.find(m=>m.id===currentMode)?.label || currentMode);

    if(currentMode==='beauty'){
      const w1 = document.createElement('span');
      w1.innerHTML = `부드러움 <input id="bs" type="range" min="0" max="20" step="1" value="${beauty.smooth}"> <b id="bsv">${beauty.smooth}</b>`;
      extra.appendChild(w1);

      const w2 = document.createElement('span');
      w2.innerHTML = `밝기 <input id="bb" type="range" min="-10" max="25" step="1" value="${beauty.bright}"> <b id="bbv">${beauty.bright}</b>`;
      extra.appendChild(w2);

      setTimeout(()=>{
        const bs=document.getElementById('bs'), bsv=document.getElementById('bsv');
        const bb=document.getElementById('bb'), bbv=document.getElementById('bbv');
        bs.oninput=()=>{ beauty.smooth=+bs.value; bsv.textContent=bs.value; };
        bb.oninput=()=>{ beauty.bright=+bb.value; bbv.textContent=bb.value; };
      },0);
    }

    if(currentMode==='surround'){
      const w = document.createElement('span');
      w.innerHTML = `프레임 최대 <input id="smax" type="range" min="8" max="40" step="1" value="${surroundMax}"> <b id="smaxv">${surroundMax}</b>`;
      extra.appendChild(w);

      setTimeout(()=>{
        const smax=document.getElementById('smax');
        const smaxv=document.getElementById('smaxv');
        smax.oninput=()=>{ surroundMax=+smax.value; smaxv.textContent=smax.value; surMaxEl.textContent=smax.value; };
      },0);
    }
  }

  function status(t){
    statusEl.textContent = '상태: ' + t;
  }

  async function startCamera(){
    try{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      status('카메라 요청중…');
      stream = await navigator.mediaDevices.getUserMedia({
        audio:false,
        video:{
          facingMode:{ ideal: currentFacing },
          width:{ ideal: 1280 },
          height:{ ideal: 960 }
        }
      });

      video.srcObject = stream;

      await new Promise(res=>{
        if(video.readyState >= 1) return res();
        video.onloadedmetadata = ()=>res();
      });

      await video.play();
      status('미리보기 ON ✅');
      renderSettings();
    }catch(e){
      console.error(e);
      status('카메라 실패 ❌');
      hint.textContent = 'HTTPS + 카메라 권한 허용 확인!';
    }
  }

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject = null;
    status('미리보기 OFF');
    renderSettings();
  }

  async function captureFrame(){
    if(!stream) throw new Error('no stream');

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 960;
    capCanvas.width = w; capCanvas.height = h;
    capCtx.drawImage(video, 0, 0, w, h);

    workCanvas.width = w; workCanvas.height = h;
    workCtx.clearRect(0,0,w,h);
    workCtx.drawImage(capCanvas, 0,0);

    return { w, h };
  }

  function canvasToBlob(c, type='image/jpeg', q=0.92){
    return new Promise(res => c.toBlob(res, type, q));
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }

  function setThumbFromBlob(blob){
    if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl = URL.createObjectURL(blob);
    thumb.src = lastBlobUrl;
  }

  // ===== Beauty filter =====
  function applyBeauty(ctx, w, h){
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const t = tmp.getContext('2d');
    t.drawImage(ctx.canvas, 0, 0);

    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.filter = `brightness(${100 + beauty.bright}%) saturate(108%)`;
    ctx.drawImage(tmp, 0, 0);
    ctx.filter = 'none';
    ctx.restore();

    if(beauty.smooth > 0){
      const blurC = document.createElement('canvas');
      blurC.width = w; blurC.height = h;
      const b = blurC.getContext('2d');
      b.filter = `blur(${Math.max(1, beauty.smooth/2)}px)`;
      b.drawImage(ctx.canvas, 0, 0);
      b.filter = 'none';

      ctx.save();
      ctx.globalAlpha = Math.min(0.55, Math.max(0.08, beauty.smooth/18));
      ctx.drawImage(blurC, 0, 0);
      ctx.restore();
    }
  }

  // ===== MultiView 2x2 =====
  async function makeMultiviewBlob(w, h){
    const outW = 1080, outH = 1080;
    const c = document.createElement('canvas');
    c.width = outW; c.height = outH;
    const x = c.getContext('2d');

    const src = document.createElement('canvas');
    src.width = w; src.height = h;
    src.getContext('2d').drawImage(capCanvas, 0, 0);

    const cell = outW/2;

    const drawCrop = (srcCanvas, dx, dy, zoom)=> {
      const sw = srcCanvas.width, sh = srcCanvas.height;
      const z = 1 + zoom; // zoom<0 => wide 느낌
      const cw = sw / z, ch = sh / z;
      const sx = (sw - cw)/2, sy = (sh - ch)/2;
      x.drawImage(srcCanvas, sx, sy, cw, ch, dx, dy, cell, cell);
    };

    // 1 기본
    drawCrop(src, 0, 0, 0.0);

    // 2 wide 느낌
    drawCrop(src, cell, 0, -0.10);

    // 3 beauty 느낌
    const beautyC = document.createElement('canvas');
    beautyC.width = w; beautyC.height = h;
    const bc = beautyC.getContext('2d', {willReadFrequently:true});
    bc.drawImage(src, 0,0);
    applyBeauty(bc, w, h);
    drawCrop(beautyC, 0, cell, 0.0);

    // 4 살짝 쨍하게
    const vivid = document.createElement('canvas');
    vivid.width = w; vivid.height = h;
    const vc = vivid.getContext('2d', {willReadFrequently:true});
    vc.drawImage(src,0,0);
    const img = vc.getImageData(0,0,w,h);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){
      d[i] = clamp255((d[i]-128)*1.08 + 128);
      d[i+1] = clamp255((d[i+1]-128)*1.08 + 128);
      d[i+2] = clamp255((d[i+2]-128)*1.08 + 128);
    }
    vc.putImageData(img,0,0);
    drawCrop(vivid, cell, cell, 0.0);

    // grid lines
    x.save();
    x.fillStyle = 'rgba(255,255,255,.35)';
    x.fillRect(cell-1, 0, 2, outH);
    x.fillRect(0, cell-1, outW, 2);
    x.restore();

    return await canvasToBlob(c, 'image/jpeg', 0.92);
  }

  // ===== Surround WebM =====
  async function saveSurroundWebm(){
    if(surroundFrames.length < 2){
      status('서라운드샷은 2장 이상 필요!');
      return;
    }

    const base = surroundFrames[0];
    const w = base.width, h = base.height;

    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const x = c.getContext('2d', {willReadFrequently:true});

    const stream2 = c.captureStream(15);
    const rec = new MediaRecorder(stream2, { mimeType:'video/webm;codecs=vp8' });
    const chunks = [];

    rec.ondataavailable = (e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
    rec.onstop = ()=>{
      const blob = new Blob(chunks, {type:'video/webm'});
      setThumbFromBlob(blob); // (이미지로는 안 보이지만 URL 유지용)
      downloadBlob(blob, `s5_surround_${Date.now()}.webm`);
    };

    rec.start();

    const frames = surroundFrames.slice();
    const back = surroundFrames.slice(1,-1).reverse();
    const seq = frames.concat(back);

    let i = 0;
    const timer = setInterval(()=>{
      x.putImageData(seq[i], 0, 0);

      x.save();
      x.fillStyle = 'rgba(0,0,0,.35)';
      x.fillRect(12,12,240,34);
      x.fillStyle = '#fff';
      x.font = '18px system-ui';
      x.fillText('SURROUND SHOT', 22, 36);
      x.restore();

      i++;
      if(i >= seq.length){
        clearInterval(timer);
        rec.stop();
      }
    }, 120);
  }

  async function onShutter(){
    if(!stream){
      status('카메라부터 시작!');
      return;
    }

    try{
      const { w, h } = await captureFrame();

      if(currentMode==='photo'){
        const blob = await canvasToBlob(workCanvas);
        setThumbFromBlob(blob);
        downloadBlob(blob, `s5_photo_${Date.now()}.jpg`);
        status('사진 저장 ✅');
        return;
      }

      if(currentMode==='beauty'){
        applyBeauty(workCtx, w, h);
        const blob = await canvasToBlob(workCanvas);
        setThumbFromBlob(blob);
        downloadBlob(blob, `s5_beauty_${Date.now()}.jpg`);
        status('뷰티페이스 저장 ✅');
        return;
      }

      if(currentMode==='multiview'){
        const blob = await makeMultiviewBlob(w, h);
        setThumbFromBlob(blob);
        downloadBlob(blob, `s5_multiview_${Date.now()}.jpg`);
        status('멀티뷰샷 저장 ✅');
        return;
      }

      if(currentMode==='surround'){
        const frame = workCtx.getImageData(0,0,w,h);
        surroundFrames.push(frame);
        surCountEl.textContent = String(surroundFrames.length);
        surMaxEl.textContent = String(surroundMax);
        status(`서라운드샷 ${surroundFrames.length}/${surroundMax}`);
        hint.textContent = `주변을 돌면서 셔터! (${surroundFrames.length}/${surroundMax})`;
        if(surroundFrames.length >= surroundMax){
          status('최대 프레임! 저장을 누르세요 ✅');
        }
        return;
      }
    }catch(e){
      console.error(e);
      status('촬영 실패');
    }
  }

  // buttons
  document.getElementById('btnStart').onclick = async ()=>{ await startCamera(); };
  document.getElementById('btnStop').onclick = ()=> stopCamera();
  document.getElementById('btnFlip').onclick = async ()=>{
    currentFacing = (currentFacing==='user') ? 'environment' : 'user';
    if(stream) await startCamera();
    renderSettings();
  };
  document.getElementById('btnShutter').onclick = ()=> onShutter();

  document.getElementById('btnSave').onclick = async ()=>{
    if(currentMode==='surround'){
      await saveSurroundWebm();
      status('서라운드샷 저장(WebM) ✅');
      return;
    }
    status('이 모드는 저장이 자동입니다');
  };

  document.getElementById('btnClear').onclick = ()=>{
    surroundFrames = [];
    surCountEl.textContent = '0';
    status('리셋 완료');
    setHintForMode();
  };

  // init
  buildModebar();
  setMode('photo');
  renderSettings();
  hint.textContent = '미리보기는 “카메라 시작”을 눌러 켜요(폰 자동재생 차단 때문).';
})();
</script>
</body>
</html>